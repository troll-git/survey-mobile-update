{"version":3,"sources":["../../../../src/commands/run/ios/resolveOptionsAsync.ts"],"names":["ignoredPaths","findXcodeProjectPaths","projectRoot","extension","absolute","cwd","ignore","resolveXcodeProject","paths","length","name","isWorkspace","CommandError","isMac","process","platform","getDefaultUserTerminal","REACT_TERMINAL","TERM_PROGRAM","TERM","env","resolveOptionsAsync","options","xcodeProject","device","isSimulator","port","bundler","reuseExistingPort","defaultPort","scheme","schemes","IOSConfig","BuildScheme","getRunnableSchemesFromXcodeproj","message","choices","map","value","isApp","type","Target","TargetType","APPLICATION","title","chalk","bold","gray","nonInteractiveHelp","join","Log","log","configuration","shouldSkipInitialBundling","shouldStartBundler","terminal","path","basename","extname"],"mappings":"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","sourcesContent":["import { IOSConfig } from '@expo/config-plugins';\nimport chalk from 'chalk';\nimport { sync as globSync } from 'glob';\nimport * as path from 'path';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { selectAsync } from '../../../prompts';\nimport { resolvePortAsync } from '../utils/resolvePortAsync';\nimport * as XcodeBuild from './XcodeBuild';\nimport { resolveDeviceAsync } from './resolveDeviceAsync';\n\nexport type XcodeConfiguration = 'Debug' | 'Release';\n\nexport type Options = {\n  device?: string | boolean;\n  port?: number;\n  scheme?: string;\n  configuration?: XcodeConfiguration;\n  bundler?: boolean;\n};\n\nexport type ProjectInfo = {\n  isWorkspace: boolean;\n  name: string;\n};\n\nconst ignoredPaths = ['**/@(Carthage|Pods|node_modules)/**'];\n\nfunction findXcodeProjectPaths(\n  projectRoot: string,\n  extension: 'xcworkspace' | 'xcodeproj'\n): string[] {\n  return globSync(`ios/*.${extension}`, {\n    absolute: true,\n    cwd: projectRoot,\n    ignore: ignoredPaths,\n  });\n}\n\nfunction resolveXcodeProject(projectRoot: string): ProjectInfo {\n  let paths = findXcodeProjectPaths(projectRoot, 'xcworkspace');\n  if (paths.length) {\n    return {\n      // Use full path instead of relative project root so that warnings and errors contain full paths as well, this helps with filtering.\n      // Also helps keep things consistent in monorepos.\n      name: paths[0],\n      // name: path.relative(projectRoot, paths[0]),\n      isWorkspace: true,\n    };\n  }\n  paths = findXcodeProjectPaths(projectRoot, 'xcodeproj');\n  if (paths.length) {\n    return { name: paths[0], isWorkspace: false };\n  }\n  throw new CommandError(`Xcode project not found in project: ${projectRoot}`);\n}\n\nconst isMac = process.platform === 'darwin';\n\nfunction getDefaultUserTerminal(): string | undefined {\n  const { REACT_TERMINAL, TERM_PROGRAM, TERM } = process.env;\n\n  if (REACT_TERMINAL) {\n    return REACT_TERMINAL;\n  }\n\n  if (isMac) {\n    return TERM_PROGRAM;\n  }\n\n  return TERM;\n}\n\nexport async function resolveOptionsAsync(\n  projectRoot: string,\n  options: Options\n): Promise<XcodeBuild.BuildProps> {\n  const xcodeProject = resolveXcodeProject(projectRoot);\n  const device = await resolveDeviceAsync(options.device);\n\n  const isSimulator = !('deviceType' in device);\n\n  let port = options.bundler\n    ? await resolvePortAsync(projectRoot, { reuseExistingPort: true, defaultPort: options.port })\n    : null;\n  // Skip bundling if the port is null\n  options.bundler = !!port;\n  if (!port) {\n    // any random number\n    port = 8081;\n  }\n\n  // @ts-ignore\n  if (options.scheme === true) {\n    const schemes = IOSConfig.BuildScheme.getRunnableSchemesFromXcodeproj(projectRoot);\n    if (!schemes.length) {\n      throw new CommandError('No native iOS build schemes found');\n    }\n    options.scheme = schemes[0].name;\n    if (schemes.length > 1) {\n      options.scheme = await selectAsync(\n        {\n          message: 'Select a scheme',\n          choices: schemes.map(value => {\n            const isApp = value.type === IOSConfig.Target.TargetType.APPLICATION;\n            return {\n              value: value.name,\n              title: isApp ? chalk.bold(value.name) + chalk.gray(' (default)') : value.name,\n            };\n          }),\n        },\n        {\n          nonInteractiveHelp: `--scheme: argument must be provided with a string in non-interactive mode. Valid choices are: ${schemes.join(\n            ', '\n          )}`,\n        }\n      );\n    } else {\n      Log.log(`Auto selecting only available scheme: ${options.scheme}`);\n    }\n  }\n\n  const configuration = options.configuration || 'Debug';\n  // This optimization skips resetting the Metro cache needlessly.\n  // The cache is reset in `../node_modules/react-native/scripts/react-native-xcode.sh` when the\n  // project is running in Debug and built onto a physical device. It seems that this is done because\n  // the script is run from Xcode and unaware of the CLI instance.\n  const shouldSkipInitialBundling = configuration === 'Debug' && !isSimulator;\n  return {\n    projectRoot,\n    isSimulator,\n    xcodeProject,\n    device,\n    configuration: options.configuration || 'Debug',\n    shouldStartBundler: options.bundler ?? false,\n    shouldSkipInitialBundling,\n    port,\n    terminal: getDefaultUserTerminal(),\n    scheme: options.scheme ?? path.basename(xcodeProject.name, path.extname(xcodeProject.name)),\n  };\n}\n"],"file":"resolveOptionsAsync.js"}